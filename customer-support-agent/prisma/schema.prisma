generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("PRISMA_DATABASE_URL")
}

model Customer {
  id            String         @id @default(cuid())
  phoneNumber   String         @unique @map("phone_number")
  name          String?
  createdAt     DateTime       @default(now()) @map("created_at")
  updatedAt     DateTime       @updatedAt @map("updated_at")
  conversations Conversation[]
  orders        Order[]
  bookings      Booking[]

  @@map("customers")
}

model Conversation {
  id             String                @id @default(cuid())
  customerId     String                @map("customer_id")
  status         ConversationStatus    @default(ACTIVE)
  startedAt      DateTime              @default(now()) @map("started_at")
  endedAt        DateTime?             @map("ended_at")
  metadata       ConversationMetadata?
  customer       Customer              @relation(fields: [customerId], references: [id], onDelete: Cascade)
  messages       Message[]
  learnedQAPairs LearnedQAPair[]

  @@index([customerId])
  @@index([status])
  @@map("conversations")
}

model Message {
  id             String       @id @default(cuid())
  conversationId String       @map("conversation_id")
  role           MessageRole
  content        String
  timestamp      DateTime     @default(now())
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  @@index([conversationId])
  @@index([timestamp])
  @@map("messages")
}

model ConversationMetadata {
  id                 String       @id @default(cuid())
  conversationId     String       @unique @map("conversation_id")
  userMood           String?      @map("user_mood")
  categories         String[]     @default([])
  redirectReason     String?      @map("redirect_reason")
  wasRedirected      Boolean      @default(false) @map("was_redirected")
  contextUsed        Boolean      @default(false) @map("context_used")
  notificationMethod String?      @map("notification_method")
  notificationSentAt DateTime?    @map("notification_sent_at")
  notificationStatus String?      @map("notification_status")
  resolutionNotes    String?      @map("resolution_notes")
  resolvedAt         DateTime?    @map("resolved_at")
  resolvedBy         String?      @map("resolved_by")

  // ===== AUTO-LEARNING: Quality Tracking Fields =====
  qualityScore      Float?    @map("quality_score")      // 0-1 score for learning eligibility
  learningEligible  Boolean   @default(false) @map("learning_eligible")
  learnedAt         DateTime? @map("learned_at")          // When Q&A was extracted

  conversation       Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  @@index([wasRedirected])
  @@index([notificationSentAt])
  @@index([learningEligible])
  @@map("conversation_metadata")
}

model Order {
  id                String            @id @default(cuid())
  orderNumber       String            @unique @map("order_number")
  customerId        String            @map("customer_id")
  status            OrderStatus       @default(PENDING)
  totalAmount       Int               @map("total_amount")
  shippingAddress   String            @map("shipping_address")
  shippingMethod    String?           @map("shipping_method")
  estimatedDelivery DateTime?         @map("estimated_delivery")
  createdAt         DateTime          @default(now()) @map("created_at")
  updatedAt         DateTime          @updatedAt @map("updated_at")
  items             OrderItem[]
  customer          Customer          @relation(fields: [customerId], references: [id], onDelete: Cascade)
  payment           Payment?
  shipping          ShippingTracking?

  @@index([customerId])
  @@index([orderNumber])
  @@index([status])
  @@map("orders")
}

model OrderItem {
  id          String @id @default(cuid())
  orderId     String @map("order_id")
  productId   String @map("product_id")
  productName String @map("product_name")
  quantity    Int
  price       Int
  subtotal    Int
  order       Order  @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@index([orderId])
  @@map("order_items")
}

model Payment {
  id            String        @id @default(cuid())
  orderId       String        @unique @map("order_id")
  amount        Int
  method        PaymentMethod
  status        PaymentStatus @default(PENDING)
  transactionId String?       @map("transaction_id")
  paidAt        DateTime?     @map("paid_at")
  invoiceUrl    String?       @map("invoice_url")
  createdAt     DateTime      @default(now()) @map("created_at")
  updatedAt     DateTime      @updatedAt @map("updated_at")
  order         Order         @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@index([orderId])
  @@index([status])
  @@map("payments")
}

model Inventory {
  id                String   @id @default(cuid())
  productId         String   @unique @map("product_id")
  productName       String   @map("product_name")
  quantity          Int
  warehouseLocation String?  @map("warehouse_location")
  lastUpdated       DateTime @default(now()) @map("last_updated")

  @@map("inventory")
}

model ShippingTracking {
  id                String           @id @default(cuid())
  orderId           String           @unique @map("order_id")
  trackingNumber    String?          @unique @map("tracking_number")
  carrier           ShippingCarrier?
  currentStatus     ShippingStatus   @default(PROCESSING)
  currentLocation   String?          @map("current_location")
  estimatedDelivery DateTime?        @map("estimated_delivery")
  deliveredAt       DateTime?        @map("delivered_at")
  shippedAt         DateTime?        @map("shipped_at")
  createdAt         DateTime         @default(now()) @map("created_at")
  updatedAt         DateTime         @updatedAt @map("updated_at")
  order             Order            @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@index([orderId])
  @@index([trackingNumber])
  @@index([currentStatus])
  @@map("shipping_tracking")
}

model AdminAuditLog {
  id          String     @id
  adminUserId String?
  action      String
  resource    String?
  resourceId  String?
  details     Json?
  ipAddress   String?
  userAgent   String?
  timestamp   DateTime   @default(now())
  AdminUser   AdminUser? @relation(fields: [adminUserId], references: [id])

  @@index([action])
  @@index([adminUserId])
  @@index([timestamp])
}

model AdminSession {
  id          String    @id
  adminUserId String
  tokenHash   String    @unique
  expiresAt   DateTime
  createdAt   DateTime  @default(now())
  ipAddress   String?
  userAgent   String?
  AdminUser   AdminUser @relation(fields: [adminUserId], references: [id], onDelete: Cascade)

  @@index([adminUserId])
  @@index([expiresAt])
  @@index([tokenHash])
}

model AdminUser {
  id            String          @id
  username      String          @unique
  passwordHash  String
  name          String
  email         String          @unique
  role          AdminRole       @default(ADMIN)
  isActive      Boolean         @default(true)
  createdAt     DateTime        @default(now())
  updatedAt     DateTime
  AdminAuditLog AdminAuditLog[]
  AdminSession  AdminSession[]

  @@index([email])
  @@index([username])
}

// ===== AUTO-LEARNING: LearnedQAPair model =====
// Stores Q&A pairs extracted from successful conversations
model LearnedQAPair {
  id                String   @id @default(cuid())
  conversationId    String   @map("conversation_id")
  sourceMessageIds  String[] @map("source_message_ids") // Which messages were used

  // Q&A content
  question          String   @db.Text
  answer            String   @db.Text
  category          String?  // e.g., "payment", "shipping", "product"

  // Quality metrics
  qualityScore      Float    @map("quality_score")      // 0-1 score
  confidenceScore   Float    @map("confidence_score")   // 0-1 score

  // Approval workflow
  status            LearnedQAStatus @default(PENDING)
  reviewedBy        String?  @map("reviewed_by")
  reviewedAt        DateTime? @map("reviewed_at")
  reviewNotes       String?  @map("review_notes") @db.Text

  // Knowledge base sync tracking
  pineconeId        String?  @unique @map("pinecone_id")
  syncedAt          DateTime? @map("synced_at")

  // Timestamps
  extractedAt       DateTime @default(now()) @map("extracted_at")
  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @updatedAt @map("updated_at")

  // Relations
  conversation      Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  @@index([conversationId])
  @@index([status])
  @@index([qualityScore])
  @@index([pineconeId])
  @@map("learned_qa_pairs")
}

// ============================================
// BOOKING SYSTEM MODELS
// ============================================

model Business {
  id            String            @id @default(cuid())
  name          String
  type          BusinessType
  phoneNumber   String            @unique @map("phone_number")
  email         String?
  address       String?
  businessHours Json              @map("business_hours")
  createdAt     DateTime          @default(now()) @map("created_at")
  updatedAt     DateTime          @updatedAt @map("updated_at")

  settings      BusinessSettings?
  resources     Resource[]
  bookings      Booking[]
  services      Service[]
  blackoutDates BlackoutDate[]

  @@map("businesses")
}

model BusinessSettings {
  id                     String   @id @default(cuid())
  businessId             String   @unique @map("business_id")
  advanceBookingDays     Int      @default(30) @map("advance_booking_days")
  minNoticeHours         Int      @default(24) @map("min_notice_hours")
  slotDurationMinutes    Int      @default(60) @map("slot_duration_minutes")
  reminderHoursBefore    Int      @default(24) @map("reminder_hours_before")
  enableWhatsAppReminder Boolean  @default(true) @map("enable_whatsapp_reminder")
  requireDepositPercent  Int?     @map("require_deposit_percent")

  business Business @relation(fields: [businessId], references: [id], onDelete: Cascade)

  @@map("business_settings")
}

model Service {
  id                String   @id @default(cuid())
  businessId        String   @map("business_id")
  name              String
  description       String?  @db.Text
  category          String?
  price             Int
  depositAmount     Int?     @map("deposit_amount")
  durationMinutes   Int      @map("duration_minutes")
  requiredResources Json?    @map("required_resources")
  isActive          Boolean  @default(true) @map("is_active")
  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @updatedAt @map("updated_at")

  business Business  @relation(fields: [businessId], references: [id], onDelete: Cascade)
  bookings Booking[]

  @@index([businessId])
  @@index([isActive])
  @@map("services")
}

model Resource {
  id           String            @id @default(cuid())
  businessId   String            @map("business_id")
  name         String
  type         ResourceType
  availability Json
  metadata     Json?
  isActive     Boolean           @default(true) @map("is_active")
  createdAt    DateTime          @default(now()) @map("created_at")
  updatedAt    DateTime          @updatedAt @map("updated_at")

  business Business          @relation(fields: [businessId], references: [id], onDelete: Cascade)
  bookings BookingResource[]

  @@index([businessId])
  @@index([type])
  @@map("resources")
}

model Booking {
  id                 String            @id @default(cuid())
  bookingNumber      String            @unique @map("booking_number")
  customerId         String            @map("customer_id")
  businessId         String            @map("business_id")
  serviceId          String            @map("service_id")
  bookingDate        DateTime          @map("booking_date")
  startTime          DateTime          @map("start_time")
  endTime            DateTime          @map("end_time")
  status             BookingStatus     @default(PENDING)
  customerName       String            @map("customer_name")
  customerPhone      String            @map("customer_phone")
  customerEmail      String?           @map("customer_email")
  notes              String?           @db.Text
  totalAmount        Int               @map("total_amount")
  depositAmount      Int?              @map("deposit_amount")
  cancellationReason String?           @map("cancellation_reason") @db.Text
  cancelledAt        DateTime?         @map("cancelled_at")
  createdAt          DateTime          @default(now()) @map("created_at")
  updatedAt          DateTime          @updatedAt @map("updated_at")

  customer  Customer          @relation(fields: [customerId], references: [id], onDelete: Cascade)
  business  Business          @relation(fields: [businessId], references: [id], onDelete: Cascade)
  service   Service           @relation(fields: [serviceId], references: [id])
  resources BookingResource[]
  payment   BookingPayment?
  reminders BookingReminder[]

  @@index([customerId])
  @@index([businessId])
  @@index([bookingNumber])
  @@index([status])
  @@index([bookingDate])
  @@map("bookings")
}

model BookingResource {
  id         String   @id @default(cuid())
  bookingId  String   @map("booking_id")
  resourceId String   @map("resource_id")

  booking  Booking  @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  resource Resource @relation(fields: [resourceId], references: [id], onDelete: Cascade)

  @@unique([bookingId, resourceId])
  @@index([bookingId])
  @@index([resourceId])
  @@map("booking_resources")
}

model BookingPayment {
  id                    String               @id @default(cuid())
  bookingId             String               @unique @map("booking_id")
  amount                Int
  paidAmount            Int                  @default(0) @map("paid_amount")
  paymentType           MidtransPaymentType  @map("payment_type")
  status                BookingPaymentStatus @default(PENDING)
  midtransOrderId       String?              @unique @map("midtrans_order_id")
  midtransTransactionId String?              @map("midtrans_transaction_id")
  paymentUrl            String?              @map("payment_url") @db.Text
  vaNumber              String?              @map("va_number")
  bank                  String?
  ewalletType           String?              @map("ewallet_type")
  qrisUrl               String?              @map("qris_url") @db.Text
  paidAt                DateTime?            @map("paid_at")
  expiredAt             DateTime?            @map("expired_at")
  refundAmount          Int?                 @map("refund_amount")
  refundedAt            DateTime?            @map("refunded_at")
  refundReason          String?              @map("refund_reason") @db.Text
  webhookData           Json?                @map("webhook_data")
  createdAt             DateTime             @default(now()) @map("created_at")
  updatedAt             DateTime             @updatedAt @map("updated_at")

  booking Booking @relation(fields: [bookingId], references: [id], onDelete: Cascade)

  @@index([bookingId])
  @@index([status])
  @@index([midtransOrderId])
  @@map("booking_payments")
}

model BlackoutDate {
  id          String   @id @default(cuid())
  businessId  String   @map("business_id")
  date        DateTime
  reason      String
  isRecurring Boolean  @default(false) @map("is_recurring")

  business Business @relation(fields: [businessId], references: [id], onDelete: Cascade)

  @@index([businessId])
  @@index([date])
  @@map("blackout_dates")
}

model BookingReminder {
  id            String         @id @default(cuid())
  bookingId     String         @map("booking_id")
  scheduledFor  DateTime       @map("scheduled_for")
  method        ReminderMethod
  status        ReminderStatus @default(PENDING)
  message       String         @db.Text
  sentAt        DateTime?      @map("sent_at")
  failureReason String?        @map("failure_reason")
  createdAt     DateTime       @default(now()) @map("created_at")

  booking Booking @relation(fields: [bookingId], references: [id], onDelete: Cascade)

  @@index([bookingId])
  @@index([scheduledFor])
  @@index([status])
  @@map("booking_reminders")
}

enum ConversationStatus {
  ACTIVE
  ENDED
  REDIRECTED
}

enum MessageRole {
  user
  assistant
}

enum OrderStatus {
  PENDING
  PROCESSING
  SHIPPED
  DELIVERED
  CANCELLED
  RETURNED
  FAILED
}

enum PaymentStatus {
  PENDING
  COMPLETED
  FAILED
  REFUNDED
}

enum PaymentMethod {
  bank_transfer
  e_wallet
  credit_card
  cod
}

enum ShippingStatus {
  PROCESSING
  PENDING_PICKUP
  IN_TRANSIT
  OUT_FOR_DELIVERY
  DELIVERED
  FAILED
  RETURNED
}

enum ShippingCarrier {
  jne
  sicepat
  tiki
  pos
  gofresh
}

enum AdminRole {
  SUPER_ADMIN
  ADMIN
  VIEWER
}

enum LearnedQAStatus {
  PENDING      // Waiting for review
  APPROVED     // Approved for knowledge base
  REJECTED     // Not suitable for learning
  SYNCED       // Successfully synced to knowledge base
  ARCHIVED     // Removed from knowledge base
}

// ============================================
// BOOKING SYSTEM ENUMS
// ============================================

enum BusinessType {
  BEAUTY_CLINIC
  TRAVEL_AGENCY
}

enum ResourceType {
  DOCTOR
  THERAPIST
  ROOM
  TOUR_GUIDE
  VEHICLE
  EQUIPMENT
}

enum BookingStatus {
  PENDING
  CONFIRMED
  CHECKED_IN
  IN_PROGRESS
  COMPLETED
  CANCELLED
  NO_SHOW
}

enum BookingPaymentStatus {
  PENDING
  SETTLEMENT
  CAPTURE
  DENY
  CANCEL
  EXPIRE
  REFUND
  PARTIAL_REFUND
}

enum MidtransPaymentType {
  BANK_TRANSFER
  GOPAY
  QRIS
  SHOPEEPAY
  CREDIT_CARD
  ECHANNEL
}

enum ReminderMethod {
  WHATSAPP
  EMAIL
  SMS
}

enum ReminderStatus {
  PENDING
  SENT
  FAILED
}
